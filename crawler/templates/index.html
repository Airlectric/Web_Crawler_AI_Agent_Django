{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="container text-center mt-5">
        <h1 class="mb-4"><i class="fas fa-robot"></i> Labs & Startups Crawler</h1>
        <p class="lead">Welcome to the crawler management interface. Use the options below to configure and run the crawler.</p>
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-cog"></i> Parameters</h5>
                        <p class="card-text">Configure crawling parameters.</p>
                        <a href="{% url 'parameters' %}" class="btn btn-primary">Go to Parameters</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-file-alt"></i> Files</h5>
                        <p class="card-text">Manage input and output files.</p>
                        <a href="{% url 'files' %}" class="btn btn-primary">Go to Files</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-database"></i> Database</h5>
                        <p class="card-text">View and edit crawled data.</p>
                        <a href="{% url 'database' %}" class="btn btn-primary">Go to Database</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-4">
            <button id="run-crawler-btn" class="btn btn-success btn-lg"><i class="fas fa-play"></i> Run Crawler Now</button>
            <button id="stop-crawler-btn" class="btn btn-danger btn-lg" style="display: none;"><i class="fas fa-stop"></i> Stop Crawler</button>
        </div>

        <!-- Progress Indicator and Logs -->
        <div id="crawler-progress" class="mt-4" style="display: none;">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Crawling in progress...</span>
            </div>
            <p class="mt-2">Crawling in progress... Please wait.</p>
        </div>
        <div id="crawler-logs" class="mt-4" style="max-height: 300px; overflow-y: auto; display: none;">
            <h5><i class="fas fa-terminal"></i> Crawler Logs</h5>
            <ul id="log-list" class="list-group"></ul>
        </div>
    </div>

    <script>
        const runBtn = document.getElementById('run-crawler-btn');
        const stopBtn = document.getElementById('stop-crawler-btn');
        const progressDiv = document.getElementById('crawler-progress');
        const logsDiv = document.getElementById('crawler-logs');
        const logList = document.getElementById('log-list');
        let logInterval;

        runBtn.addEventListener('click', function() {
            // Show progress, logs, and stop button
            progressDiv.style.display = 'block';
            logsDiv.style.display = 'block';
            runBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            logList.innerHTML = '<li class="list-group-item"><i class="fas fa-comment"></i> Starting crawler...</li>';

            // Start the crawler
            fetch("{% url 'run_crawler' %}", { method: 'GET' })
                .then(response => {
                    if (!response.ok) throw new Error('Crawler request failed');
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'started') {
                        // Poll logs every second
                        logInterval = setInterval(() => {
                            fetch("{% url 'get_logs' %}")
                                .then(response => response.json())
                                .then(data => {
                                    logList.innerHTML = ''; // Clear and rebuild list
                                    data.logs.forEach(log => {
                                        const li = document.createElement('li');
                                        li.className = 'list-group-item';
                                        if (log.includes('INFO')) {
                                            li.className += ' list-group-item-info';
                                            li.innerHTML = '<i class="fas fa-info-circle"></i> ' + log;
                                        } else if (log.includes('WARNING')) {
                                            li.className += ' list-group-item-warning';
                                            li.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + log;
                                        } else if (log.includes('ERROR')) {
                                            li.className += ' list-group-item-danger';
                                            li.innerHTML = '<i class="fas fa-times-circle"></i> ' + log;
                                        } else {
                                            li.innerHTML = '<i class="fas fa-comment"></i> ' + log;
                                        }
                                        logList.appendChild(li);
                                    });

                                    // Check for completion or stop
                                    if (data.logs.some(log => log.includes('Crawler execution completed') || log.includes('Crawler stopped'))) {
                                        clearInterval(logInterval);
                                        progressDiv.style.display = 'none';
                                        runBtn.style.display = 'inline-block';
                                        stopBtn.style.display = 'none';
                                        setTimeout(() => window.location.href = "{% url 'database' %}", 1000);
                                    }
                                })
                                .catch(error => console.error('Error fetching logs:', error));
                        }, 1000);
                    } else if (data.status === 'already_running') {
                        logList.innerHTML = '<li class="list-group-item list-group-item-warning"><i class="fas fa-exclamation-triangle"></i> Crawler is already running</li>';
                        progressDiv.style.display = 'none';
                        runBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error starting crawler:', error);
                    progressDiv.style.display = 'none';
                    runBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    logList.innerHTML = '<li class="list-group-item list-group-item-danger"><i class="fas fa-times-circle"></i> Error starting crawler</li>';
                });
        });

        stopBtn.addEventListener('click', function() {
            fetch("{% url 'stop_crawler' %}", { method: 'GET' })
                .then(response => {
                    if (!response.ok) throw new Error('Stop request failed');
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'stopped') {
                        clearInterval(logInterval);
                        progressDiv.style.display = 'none';
                        runBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                        logList.innerHTML += '<li class="list-group-item list-group-item-warning"><i class="fas fa-exclamation-triangle"></i> Crawler stopped by user</li>';
                        setTimeout(() => window.location.href = "{% url 'database' %}", 1000);
                    } else if (data.status === 'not_running') {
                        logList.innerHTML += '<li class="list-group-item list-group-item-warning"><i class="fas fa-exclamation-triangle"></i> No crawler is running</li>';
                    }
                })
                .catch(error => {
                    console.error('Error stopping crawler:', error);
                    logList.innerHTML += '<li class="list-group-item list-group-item-danger"><i class="fas fa-times-circle"></i> Error stopping crawler</li>';
                });
        });
    </script>
{% endblock %}